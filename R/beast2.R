##' For more information see: \itemize{ \item{For
##' BEAST1}{\url{http://www.phylo.org/rest/beast2_xsede.html} and the
##' BEAST2 website \url{http://beast2.org}} \item{For
##' BEAST2}{\url{http://www.phylo.org/index.php/rest/beast_tg.html}
##' and the BEAST website \url{http://beast.bio.ed.ac.uk}} }
##'
##' Specifying the number of partitions and patterns in the alignments
##' are not required by BEAST, but are used by CIPRES to optimize the
##' computing parameters for improved run times.
##'
##' @title Submit a BEAST or BEAST2 analysis
##' @param input_file An XML input file generated by BEAUTI2
##' @param beast_version Which version of BEAST2 should be used?
##' @template max_runtime
##' @param use_beagle Should the BEAGLE library be used?
##' @param use_seed If \code{NULL} (default), a random seed will be
##'     generated by BEAST, otherwise specify your own seed.
##' @param overwrite_logs Should existing log files on the server be
##'     overwritten?
##' @template get_email
##' @template job_name
##' @template note
##' @template dotdotdot
##' @importFrom assertthat assert_that is.count is.flag
##' @importFrom httr upload_file
##' @rdname beast
##' @export
cipres_submit_beast2 <- function(input_file,
                                 beast_version = c("2.3.0", "2.1.3"),
                                 max_runtime = 10,
                                 use_beagle = TRUE,
                                 use_seed = NULL,
                                 overwrite_logs = TRUE,
                                 job_name = NULL,
                                 get_email = TRUE,
                                 note = NULL,
                                 ...) {

    beast_version <- match.arg(beast_version)
    beast_version <- switch(beast_version,
                            "2.3.0" = "30",
                            "2.1.3" = "13")

    alg_info <- parse_beast2_xml(input_file)
    n_patterns <- alg_info[["n_patterns"]]
    n_partitions <- alg_info[["n_partitions"]]

    assertthat::assert_that(is_maxruntime(max_runtime))
    assertthat::assert_that(assertthat::is.count(n_patterns))
    assertthat::assert_that(assertthat::is.flag(use_beagle))
    assertthat::assert_that(assertthat::is.flag(overwrite_logs))

    input_file <- normalizePath(input_file)
    check_file(input_file)

    bdy <- .cipres_submit_beast2(input_file = input_file, beast_version, max_runtime,
                                 use_beagle, n_patterns, n_partitions, use_seed,
                                 overwrite_logs, job_name, get_email)

    cipres_submit(bdy, tool = "BEAST2_XSEDE", job_name = job_name,
                  note = note, ...)
}

## The list construction is separated from the submission part to
## allow for writing unit tests.
.cipres_submit_beast2 <- function(input_file,
                                  beast_version,
                                  max_runtime,
                                  use_beagle,
                                  n_patterns,
                                  n_partitions,
                                  use_seed,
                                  overwrite_logs,
                                  job_name,
                                  get_email) {

    ## documentation: http://www.phylo.org/rest/beast2_xsede.html

    bdy <- list(
        `input.infile_` = httr::upload_file(input_file),
        `vparam.runtime_` = max_runtime,
        `vparam.nu_patterns_` = n_patterns,
        `vparam.which_beast2_` = beast_version,
        `vparam.no_beagle_` = as.numeric(!use_beagle),
        `vparam.overwrite_logs_` = as.numeric(overwrite_logs)
        )

    bdy <- beast_check_partitions(bdy, n_partitions, beast2 = TRUE)
    bdy <- beast_use_seed(bdy, use_seed)
    bdy <- add_meta_data(bdy, get_email, job_name)
    bdy
}

##' @importFrom xml2 read_xml xml_find_all xml_text xml_contents xml_find_one
parse_beast2_xml <- function(input_file) {
    bst <- xml2::read_xml(x = input_file)

    ## Number of siteModel elements gives the number of partitions
    n_partitions <- length(xml2::xml_find_all(bst, ".//siteModel[@id]"))

    ## Length of the first sequence gives the number of elements
    n_patterns <- nchar(xml2::xml_text(xml2::xml_contents(
        xml2::xml_find_one(bst, ".//sequence[1]/@value")
    )))

    list(n_partitions = n_partitions,
         n_patterns = n_patterns)
}
